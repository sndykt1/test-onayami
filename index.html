<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã²ã‚‰ãŒãªãƒã‚¤ãƒ©ã‚¤ãƒˆå ã„</title>
  <style>
    :root {
      --accent: #3a86ff;
      --ink: #1f2937;
      --muted: #6b7280;
      --bg: #f8fafc;
      --paper: #ffffff;
      --hl: #fff59d;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic UI", sans-serif;
      color: var(--ink); background: var(--bg);
    }
    header {
      position: sticky; top: 0; z-index: 10; backdrop-filter: blur(8px);
      background: rgba(248,250,252,0.8); border-bottom: 1px solid #e5e7eb;
    }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 1.25rem; margin: 0 0 8px; }
    .toolbar {
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center; padding: 8px 0 12px;
    }
    button, select, input[type="number"], input[type="text"] {
      border: 1px solid #d1d5db; background: #fff; color: var(--ink);
      border-radius: 10px; padding: 8px 12px; font-size: 14px; cursor: pointer;
    }
    button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    button.ghost { background: #f3f4f6; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .grid { display: grid; grid-template-columns: 1fr 360px; gap: 16px; align-items: start; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card {
      background: var(--paper); border: 1px solid #e5e7eb; border-radius: 16px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    #transcript {
      min-height: 300px; line-height: 1.75; white-space: pre-wrap; word-wrap: break-word;
    }
    .hint { color: var(--muted); font-size: 12px; }
    .highlight { background: var(--hl); border-radius: 6px; padding: 0 1px; }
    .muted { color: var(--muted); }
    .kanafused { font-variant-east-asian: proportional-width; letter-spacing: .02em; }

    .result {
      font-size: 18px; line-height: 1.7; padding-top: 6px;
    }

    @media print {
      header, .toolbar, .controls, .hint, .no-print { display: none !important; }
      body { background: #fff; }
      .card { border: none; box-shadow: none; padding: 0; }
      .wrap { max-width: 700px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ãŠæ‚©ã¿ç›¸è«‡å®¤ Ã— å ã„ â€” ã²ã‚‰ãŒãªãƒã‚¤ãƒ©ã‚¤ãƒˆ</h1>
      <div class="toolbar">
        <button id="btnStart" class="primary">ğŸ™ï¸ æ–‡å­—èµ·ã“ã—é–‹å§‹</button>
        <button id="btnStop" class="ghost" disabled>â¹ åœæ­¢</button>
        <label class="muted">æŠ½å‡ºã™ã‚‹æ–‡å­—æ•°ï¼š<input id="count" type="number" value="12" min="1" max="200" style="width:88px"></label>
        <button id="btnHighlight">âœ¨ ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆ</button>
        <button id="btnClear">ğŸ§¹ ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤</button>
        <button id="btnFortune">ğŸ”® å ã„ç”Ÿæˆ</button>
        <button id="btnPrint" class="no-print">ğŸ–¨ï¸ å°åˆ·</button>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <section class="card">
      <div class="muted" style="margin-bottom:6px; display:flex; gap:8px; align-items:center;">
        <span>â–¼ ä¼šè©±ã®æ–‡å­—èµ·ã“ã—ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ãƒ»æ‰‹æ‰“ã¡ç·¨é›†ã‚‚å¯ï¼‰</span>
        <label class="muted" style="margin-left:auto">æ›´æ–°æ–¹å¼ï¼š
          <select id="mode">
            <option value="realtime" selected>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°èªè­˜</option>
            <option value="manual">æ‰‹å…¥åŠ›ï¼ˆãƒšãƒ¼ã‚¹ãƒˆå¯ï¼‰</option>
          </select>
        </label>
      </div>
      <div id="transcript" contenteditable="true" class="card" style="border:1px dashed #e5e7eb; min-height:360px;"></div>
      <div class="hint" style="margin-top:8px;">â€» ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ èªè­˜ã¯Chromeã®Web Speech APIã‚’ä½¿ç”¨ã—ã¾ã™ã€‚æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã§ã¯è‡ªç”±ã«ç·¨é›†ã§ãã¾ã™ã€‚</div>
    </section>

    <aside class="card">
      <h3 style="margin-top:0;">å ã„çµæœ</h3>
      <div class="muted">ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ãŸã€Œã²ã‚‰ãŒãªã€ã‚’ã¤ãªã„ã æ–‡å­—åˆ—ã‚’ç¨®ã«ã—ã¦ã€çµæœã‚’æ±ºã‚ã¾ã™ã€‚</div>
      <div style="margin-top:10px;">
        <div class="muted">æŠ½å‡ºã•ã‚ŒãŸã²ã‚‰ãŒãªï¼š</div>
        <div id="kanaKey" class="card kanafused" style="min-height:44px;"></div>
      </div>
      <div class="result" id="fortuneText"></div>
      <div class="hint">â€» åŒã˜æ–‡å­—åˆ—ã‹ã‚‰ã¯æ¯å›åŒã˜çµæœãŒå‡ºã¾ã™ï¼ˆç–‘ä¼¼ä¹±æ•°ã‚’å›ºå®šï¼‰ã€‚</div>
    </aside>
  </main>

  <script>
    // =============================
    // Utilities
    // =============================
    const HIRA_RE = /[\u3041-\u3096]/; // ã-ã‚–ï¼ˆæ‹—éŸ³å«ã‚€ï¼‰
    const HIRA_GLOBAL_RE = /[\u3041-\u3096]/g;

    function getPlainTextFromTranscript() {
      const div = document.getElementById('transcript');
      // remove zero-width & normalize
      return div.innerText.replace(/[\u200B\u200C\u200D]/g, '').normalize('NFC');
    }

    function findHiraganaPositions(text) {
      const positions = [];
      for (let i = 0; i < text.length; i++) {
        if (HIRA_RE.test(text[i])) positions.push(i);
      }
      return positions;
    }

    // Fisher-Yates sampling without replacement (partial shuffle)
    function sampleUnique(arr, k, rng) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a.slice(0, Math.min(k, a.length)).sort((x,y) => x - y);
    }

    // Seeded RNG (Mulberry32)
    function mulberry32(seed) {
      let t = seed >>> 0;
      return function() {
        t += 0x6D2B79F5;
        let x = Math.imul(t ^ (t >>> 15), 1 | t);
        x ^= x + Math.imul(x ^ (x >>> 7), 61 | x);
        return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
      }
    }

    function hashStringToInt(s) {
      // simple djb2
      let h = 5381;
      for (let i = 0; i < s.length; i++) h = ((h << 5) + h) + s.charCodeAt(i);
      return h >>> 0;
    }

    // =============================
    // Highlight Logic
    // =============================
    let highlightedIndices = new Set();

    function renderHighlighted(text, indicesSet) {
      // Rebuild HTML with <span> around highlighted characters
      const indices = [...indicesSet].sort((a,b)=>a-b);
      let html = '';
      let idxp = 0;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (idxp < indices.length && i === indices[idxp]) {
          html += `<span class="highlight">${escapeHtml(ch)}</span>`;
          idxp++;
        } else {
          html += escapeHtml(ch);
        }
      }
      const div = document.getElementById('transcript');
      div.innerHTML = html;
    }

    function escapeHtml(str) {
      return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    function extractKanaFromHighlights(text, indicesSet) {
      const arr = [...indicesSet].sort((a,b)=>a-b).map(i => text[i] || '').join('');
      document.getElementById('kanaKey').textContent = arr;
      return arr;
    }

    function highlightRandom() {
      const k = Math.max(1, Math.min(parseInt(document.getElementById('count').value || '12', 10), 200));
      const text = getPlainTextFromTranscript();
      const positions = findHiraganaPositions(text);
      const seed = hashStringToInt(text + '|' + k); // å†…å®¹Ã—å€‹æ•°ã§æ±ºå®šçš„
      const rng = mulberry32(seed);
      const sampled = sampleUnique(positions, k, rng);
      highlightedIndices = new Set(sampled);
      renderHighlighted(text, highlightedIndices);
      extractKanaFromHighlights(text, highlightedIndices);
    }

    function clearHighlights() {
      highlightedIndices.clear();
      const text = getPlainTextFromTranscript();
      const div = document.getElementById('transcript');
      div.textContent = text; // plain reset
      document.getElementById('kanaKey').textContent = '';
      document.getElementById('fortuneText').textContent = '';
    }

    // =============================
    // Fortune Logicï¼ˆã‚­ãƒ¼æ–‡å­—ä¸€è‡´ã‚’å„ªå…ˆ & ä¾‹:ã€Œãã€â†’ ãã„ã‚ï¼‰
    // =============================
    const ITEMS = [
      'ã¯ã•ã¿', 'ã»ã†ã', 'ãµã›ã‚“', 'ã¯ã‚“ã‹ã¡', 'ã»ã£ã¨ã‘ãƒ¼ã', 'ãµã§ã°ã“',
      'ã²ã®ãã®æ', 'ã»ã—ã®ã‚·ãƒ¼ãƒ«', 'ãµã†ã›ã‚“', 'ã¸ã‚ã”ã‚€', 'ã»ã†ã˜èŒ¶',
      'ãµãã‚', 'ã²ã¾ã‚ã‚Šã®ãŸã­', 'ã¸ã‚“ãã†ã‚ãŒã­', 'ã»ãŸã‚‹ã¶ãã‚'
    ];

    // ãƒãƒƒãƒã—ã‚„ã™ã„è‰²åã‚’è¿½åŠ 
    const COLORS = [
      'ã‚‚ã‚‚ã„ã‚','ã¿ãšã„ã‚','ã‚€ã‚‰ã•ã','ã¿ã©ã‚Š','ã‚€ãã¡ã‚ƒã„ã‚','ã‚ã‚ã‚“ããƒ¼ã ',
      'ã‚‚ãã‚ˆã†ã®ã‚ã•ã®ã„ã‚',
      // è¿½åŠ ï¼ˆå˜éŸ³ç¯€ç³»ã‚‚ï¼‰
      'ã‚ã‹','ã‚ãŠ','ãã„ã‚','ãã¿ã©ã‚Š','ãã‚','ã—ã‚'
    ];

    const LUCKS = [
      'ãã‚‡ã†ã¯èãå½¹ã«ã¾ã‚ã‚‹ã¨å‰',
      'ãã£ã·ã®ã‚ˆã„è¡Œå‹•ãŒé‹ã‚’ã²ã‚‰ã',
      'ã‘ã„ã‘ã‚“è€…ã®ã²ã¨ã“ã¨ã«ãƒ’ãƒ³ãƒˆã‚ã‚Š',
      'ã“ã ã‚ã‚Šã™ããšè»½ã‚„ã‹ã«å‹•ãã¨é€²å±•',
      'ãã†ãã‚’å…¥ã‚Œã‹ãˆã‚‹ã¨æµã‚Œâ—',
      'ã“ã“ã‚ã‚’è¨€è‘‰ã«ã—ã¦ã¿ã‚‹ã¨æ•´ç†ã§ãã‚‹'
    ];

    // ã²ã‚‰ãŒãªã®é‡è¤‡ã‚’é™¤ã„ãŸé…åˆ—ã‚’è¿”ã™
    function keyChars(key) {
      const ks = (key || '').match(/[\u3041-\u3096]/g) || [];
      return Array.from(new Set(ks));
    }

    // ã‚­ãƒ¼æ–‡å­—ã‚’å«ã‚€å€™è£œã‚’å„ªå…ˆï¼ˆè©²å½“ãªã—ãªã‚‰å…ƒé…åˆ—ï¼‰
    function preferByChars(arr, chars) {
      const matched = arr.filter(s => chars.some(c => s.includes(c)));
      return matched.length ? matched : arr;
    }

    // æ–‡å­—â†’ã‚«ãƒ©ãƒ¼ã®å¼·åˆ¶ãƒãƒƒãƒ—ï¼ˆæ‹¡å¼µã—ã‚„ã™ã„ï¼‰
    function colorOverride(chars) {
      if (chars.includes('ã')) return 'ãã„ã‚';  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹
      if (chars.includes('ã‚')) return 'ã‚ã‹';
      if (chars.includes('ã¿')) return 'ã¿ã©ã‚Š';
      if (chars.includes('ã‚€')) return 'ã‚€ã‚‰ã•ã';
      return null;
    }

    function fortuneFromKey(key) {
      const seed = hashStringToInt(key || 'default');
      const rng = mulberry32(seed);
      const chars = keyChars(key);

      function pick(arr) { return arr[Math.floor(rng() * arr.length)]; }

      const itemsCand = preferByChars(ITEMS, chars);
      const lucksCand = preferByChars(LUCKS, chars);

      const forced = colorOverride(chars);
      const colorsCand = forced ? [forced] : preferByChars(COLORS, chars);

      const item = pick(itemsCand);
      const color = pick(colorsCand);
      const luck = pick(lucksCand);

      return `ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ï¼š${item}ã€€/ã€€ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼ï¼š${color}\n${luck}`;
    }

    function runFortune() {
      const text = getPlainTextFromTranscript();
      // ã²ã‚‰ãŒãªæœªé¸æŠãªã‚‰è‡ªå‹•æŠ½å‡º
      if (!highlightedIndices.size) highlightRandom();
      const key = extractKanaFromHighlights(text, highlightedIndices);
      const result = fortuneFromKey(key);
      document.getElementById('fortuneText').textContent = result;
    }

    // =============================
    // Speech Recognition (Web Speech API)
    // =============================
    let recognition = null;
    let recognizing = false;

    function initRecognizer() {
      const m = document.getElementById('mode').value;
      if (m !== 'realtime') return;
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã‚’ãŠè©¦ã—ãã ã•ã„ã€‚'); return; }
      recognition = new SR();
      recognition.lang = 'ja-JP';
      recognition.continuous = true;
      recognition.interimResults = true;

      recognition.onresult = (event) => {
        const results = Array.from(event.results);
        const text = results.map(r => r[0].transcript).join('');
        const div = document.getElementById('transcript');
        div.textContent = text; // ã‚·ãƒ³ãƒ—ãƒ«ã«æœ€æ–°ã‚’è¡¨ç¤º
        if (highlightedIndices.size) {
          const plain = getPlainTextFromTranscript();
          renderHighlighted(plain, highlightedIndices);
        }
      };

      recognition.onend = () => {
        recognizing = false;
        toggleButtons();
      };
    }

    function startRec() {
      if (document.getElementById('mode').value !== 'realtime') return;
      if (!recognition) initRecognizer();
      if (!recognition) return;
      recognizing = true; toggleButtons();
      try { recognition.start(); } catch (e) {}
    }
    function stopRec() { if (recognition && recognizing) { recognition.stop(); } }

    function toggleButtons() {
      document.getElementById('btnStart').disabled = recognizing || document.getElementById('mode').value !== 'realtime';
      document.getElementById('btnStop').disabled = !recognizing;
    }

    // =============================
    // Events
    // =============================
    document.getElementById('btnStart').addEventListener('click', startRec);
    document.getElementById('btnStop').addEventListener('click', stopRec);
    document.getElementById('btnHighlight').addEventListener('click', highlightRandom);
    document.getElementById('btnClear').addEventListener('click', clearHighlights);
    document.getElementById('btnFortune').addEventListener('click', runFortune);
    document.getElementById('btnPrint').addEventListener('click', () => window.print());
    document.getElementById('mode').addEventListener('change', (e) => {
      if (recognizing) stopRec();
      const manual = e.target.value === 'manual';
      document.getElementById('btnStart').disabled = manual;
      document.getElementById('btnStop').disabled = true;
    });

    // åˆæœŸåŒ–
    initRecognizer();
  </script>
</body>
</html>